<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://cdn.skypack.dev blob:; worker-src 'self' blob:; connect-src 'self' https://cdn.jsdelivr.net https://cdn.skypack.dev blob:;">
    <title>CS 1.6</title>
    <script src="coi-serviceworker.js"></script>
    <style>
        canvas { width: 100vw; height: 100vh; top: 0; left: 0; position: fixed; }
        body { margin: 0; background: black; }
        #status { color: white; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: monospace; font-size: 18px; z-index: 10; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xash3d-fwgs@latest/dist/raw.js"></script>
</head>
<body>
<div id="status">Loading...</div>
<canvas id="canvas"></canvas>
<script type="module">
    import JSZip from 'https://cdn.skypack.dev/jszip@3.10.1';

    const status = document.getElementById('status');
    const CDN  = 'https://cdn.jsdelivr.net/npm/xash3d-fwgs@latest/dist/';
    const CS16 = 'https://cdn.jsdelivr.net/npm/cs16-client@latest/dist/cstrike/';

    async function main() {
        const chunkUrls = [
            './valve.zip.part1',
            './valve.zip.part2',
            './valve.zip.part3',
            './valve.zip.part4',
            './valve.zip.part5',
        ];

        status.textContent = 'Downloading game chunks...';
        const chunks = await Promise.all(
            chunkUrls.map((url, i) =>
                fetch(url).then(async r => {
                    if (!r.ok) throw new Error(`Chunk ${i + 1} not found: ${url}`);
                    console.log(`Chunk ${i + 1} downloaded`);
                    return r.arrayBuffer();
                })
            )
        );

        status.textContent = 'Merging chunks...';
        const totalLength = chunks.reduce((sum, c) => sum + c.byteLength, 0);
        const merged = new Uint8Array(totalLength);
        let offset = 0;
        for (const chunk of chunks) {
            merged.set(new Uint8Array(chunk), offset);
            offset += chunk.byteLength;
        }

        status.textContent = 'Extracting zip...';
        const zip = await JSZip.loadAsync(merged);
        const files = {};
        await Promise.all(Object.keys(zip.files).map(async p => {
            const file = zip.files[p];
            if (file.dir) return;
            files[`/rodir/${p}`] = await file.async("uint8array");
        }));

        status.textContent = 'Starting game...';

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('webgl2', {
            alpha: false,
            depth: true,
            stencil: true,
            antialias: false,
            powerPreference: 'high-performance',
            preserveDrawingBuffer: true,
            failIfMajorPerformanceCaveat: false
        });

        Xash3D({
            arguments: ['-windowed', '-game', 'cstrike', '+_vgui_menus', '0', '-ref', 'gl'],
            canvas,
            ctx,
            dynamicLibraries: [
                'filesystem_stdio.wasm',
                'cl_dlls/menu_emscripten_wasm32.wasm',
                'dlls/cs_emscripten_wasm32.wasm',
                'cl_dlls/client_emscripten_wasm32.wasm',
                '/rwdir/filesystem_stdio.so',
            ],
            onRuntimeInitialized: function () {
                Object.entries(files).forEach(([k, v]) => {
                    const dir = k.split('/').slice(0, -1).join('/');
                    this.FS.mkdirTree(dir);
                    this.FS.writeFile(k, v);
                });
                this.FS.chdir('/rodir');
                status.style.display = 'none';
            },
            locateFile: (p) => {
                switch (p) {
                    case 'xash.wasm':
                        return CDN + 'xash.wasm';
                    case 'filesystem_stdio.wasm':
                    case '/rwdir/filesystem_stdio.so':
                        return CDN + 'filesystem_stdio.wasm';
                    case 'libref_gles3compat.wasm':
                        return CDN + 'libref_gles3compat.wasm';
                    case 'cl_dlls/menu_emscripten_wasm32.wasm':
                        return CS16 + 'cl_dlls/menu_emscripten_wasm32.wasm';
                    case 'dlls/cs_emscripten_wasm32.wasm':
                        return CS16 + 'dlls/cs_emscripten_wasm32.wasm';
                    case 'cl_dlls/client_emscripten_wasm32.wasm':
                        return CS16 + 'cl_dlls/client_emscripten_wasm32.wasm';
                    default:
                        return p;
                }
            },
        });
    }

    main().catch(e => {
        status.textContent = 'Error: ' + e.message;
        console.error(e);
    });
</script>
</body>
</html>

