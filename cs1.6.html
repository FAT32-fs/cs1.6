<!DOCTYPE html>
<html>
<head>
    <title>CS 1.6</title>
    <script src="coi-serviceworker.js"></script>
    <style>
        canvas {
            width: 100vw;
            height: 100vh;
            top: 0;
            left: 0;
            position: fixed;
        }
        body {
            margin: 0;
            background: black;
        }
        #status {
            color: white;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: monospace;
            font-size: 18px;
            z-index: 10;
        }
    </style>
</head>
<body>
<div id="status">Loading chunks...</div>
<canvas id="canvas"></canvas>
<script type="module">
    import JSZip from 'https://cdn.skypack.dev/jszip@3.10.1';
    import { Xash3D } from 'https://cdn.jsdelivr.net/npm/xash3d-fwgs@latest/+esm';

    const status = document.getElementById('status');

    const clientUrl = 'https://cdn.jsdelivr.net/npm/cs16-client@latest/cl_dll/client_emscripten_wasm32.wasm';
    const menuUrl   = 'https://cdn.jsdelivr.net/npm/cs16-client@latest/cl_dll/menu_emscripten_wasm32.wasm';
    const serverUrl = 'https://cdn.jsdelivr.net/npm/cs16-client@latest/dlls/cs_emscripten_wasm32.so';

    async function main() {
        const chunkUrls = [
            './valve.zip.part1',
            './valve.zip.part2',
            './valve.zip.part3',
            './valve.zip.part4',
            './valve.zip.part5',
        ];

        status.textContent = 'Downloading chunks...';

        const chunks = await Promise.all(
            chunkUrls.map((url, i) =>
                fetch(url).then(async r => {
                    if (!r.ok) throw new Error(`Chunk ${i + 1} not found: ${url}`);
                    console.log(`Chunk ${i + 1} downloaded`);
                    return r.arrayBuffer();
                })
            )
        );

        status.textContent = 'Merging chunks...';

        const totalLength = chunks.reduce((sum, c) => sum + c.byteLength, 0);
        const merged = new Uint8Array(totalLength);
        let offset = 0;
        for (const chunk of chunks) {
            merged.set(new Uint8Array(chunk), offset);
            offset += chunk.byteLength;
        }

        status.textContent = 'Extracting zip...';

        const zip = await JSZip.loadAsync(merged);
        const files = {};

        await Promise.all(Object.keys(zip.files).map(async p => {
            const file = zip.files[p];
            if (file.dir) return;
            files[`/rodir/${p}`] = await file.async("uint8array");
        }));

        status.textContent = 'Starting game...';

        const x = new Xash3D({
            canvas: document.getElementById('canvas'),
            args: ['-windowed', '-game', 'cstrike', '+_vgui_menus', '0'],
            libraries: {
                menu: menuUrl,
                client: clientUrl,
                server: serverUrl,
            },
        });

        await x.init();

        Object.keys(files).forEach(k => {
            const dir = k.split('/').slice(0, -1).join('/');
            x.FS.mkdirTree(dir);
            x.FS.writeFile(k, files[k]);
        });

        x.FS.chdir('/rodir');
        status.style.display = 'none';
        x.main();
    }

    main().catch(e => {
        status.textContent = 'Error: ' + e.message;
        console.error(e);
    });
</script>
</body>
</html>
